var mg=(function(b){var a={options:{directory:"weizhoukan",json:path+"weizhoukan/magazine.json",numberOfPagesToLoad:3,sliderMove:800,fullpage:false,animationTime:300,animationType:"linear",sidebar:true,sidebarFixed:true,scrolling:{hScrollbar:false,vScrollbar:false,hScroll:false,bounce:false,overflow:"hidden",desktopCompatibility:true}},maxPage:1,startPeriod:26,currentPeriod:26,allPeriod:29,startLeft:-80,step:85,numberOfPagesLoaded:0,currentPage:0,currentPosition:0,keyCode:0,animation:(window.WebKitCSSMatrix?"3d":""),touchEnabled:(typeof(document.ontouchmove)!=="undefined"?true:false),mouse:{initiated:false},sidebarCategoryActive:26,sidebarHightList:[],sidebarScroller:{},slideScroller:{},loadingSequence:{first:[{slide:4,page:2},{slide:3,page:1},{slide:2,page:0}],second:[{slide:1,page:-1},{slide:4,page:2},{slide:3,page:1},{slide:2,page:0}],third:[{slide:0,page:-2},{slide:1,page:-1},{slide:4,page:2},{slide:3,page:1},{slide:2,page:0}],middle:[{slide:0,page:-2},{slide:1,page:-1},{slide:4,page:2},{slide:3,page:1},{slide:2,page:0}],last:[{slide:0,page:-2},{slide:1,page:-1},{slide:2,page:0}],"last-but-one":[{slide:0,page:-2},{slide:1,page:-1},{slide:3,page:1},{slide:2,page:0}],"last-but-two":[{slide:0,page:-2},{slide:1,page:-1},{slide:4,page:2},{slide:3,page:1},{slide:2,page:0}]},init:function(){console.log(window.location.href);a.loadOptions(a.start);a.sidebar=$("#mg-sidebar");a.slider=$("#mg-slider");a.firstSlide=$("#mg-slide-2");a.buttonOpen=$("#mg-sidebar-button-open");a.buttonClose=$("#mg-sidebar-button-close")},start:function(){var c;a.maxPage=(a.get("category")[a.currentPeriod].length-1);if(a.get("fullpage")===true){$("body").attr("id","fullpage");a.startLeft=-100;a.step=100}if(a.options.sidebar===true){if(a.options.sidebarFixed===true){$("body").addClass("fixed")}else{a.buttonOpen.show();a.buttonClose.show()}a.loadSidebar()}},get:function(c){if(typeof(a.options[c])!=="undefined"){return a.options[c]}else{return b}},set:function(c,d){a.options[c]=d}};return a}());window.mg=mg||{};(function(a,b){a.loadSidebar=function(){$.ajax({type:"get",url:path+""+a.get("directory")+"/sidebar.html",async:false,success:function(d){$(d).appendTo("#mg-sidebar");a.loadSidebarSuccess();a.slides=[];for(i=0;i<=4;i++){a.slides.push({slideId:i,left:a.step*(i-2),page:i-2})}a.loadPage($("#mg-slide-2"),0);a.loadPage($("#mg-slide-3"),1);a.loadPage($("#mg-slide-4"),2);a.bindEvents();$("#currentPeriod").attr("class",a.currentPeriod);a.setTitle(a.currentPeriod);a.setHref(a.currentPeriod);if(a.hasSessionData(a.getHref())){var c=parseInt(a.getSessionData(a.getHref()));if(c!=null){if(c!=a.currentPage){a.gotoPage(c,a.currentPeriod)}}}},error:function(d,c){alert("some error happens")}})};a.loadSidebarSuccess=function(){a.createSidebar();a.createContents();if(a.touchEnabled===true){a.buttonOpen.tap(a.sidebarShow);a.buttonClose.tap(a.sidebarHide)}else{a.buttonOpen.bind("click",a.sidebarShow);a.buttonClose.bind("click",a.sidebarHide)}a.sidebarEvents();a.sidebarCalculate();if(a.touchEnabled===true){a.addEvent("sidebar-category-content-"+a.currentPeriod,"webkitTransitionEnd",a.sidebarListener)}else{a.addEvent("sidebar-category-content-"+a.currentPeriod,"transitionend",a.sidebarListener)}$(".sidebar-category-content").css("height",0);$("#sidebar-category-content-"+a.currentPeriod).css("height",a.sidebarHightList[a.currentPeriod]);a.sidebarScroller=new iScroll("mg-sidebar",a.options.scrolling)};a.createSidebar=function(){var e="";for(var d=a.startPeriod;d<=a.allPeriod;d++){e+='<div id="sidebar-category-'+d+'" class="sidebar-list-category">';e+='<p class="item-text">';e+=d+"期";e+="</p>";e+="</div>";e+='<ul id="sidebar-category-content-'+d+'" class="sidebar-category-content">';for(var c=0;c<a.get("category")[d].length;c++){e+='<li id="page-'+d+"-"+c+'" class="sidebar-list-item">';e+='<p class="item-text">';e+=a.get("category")[d][c];e+="</p>";e+="</li>"}e+="</ul>"}$(e).appendTo("#sidebar-list")};a.createContents=function(){var d=[];for(var c=0;c<a.get("category")[a.currentPeriod].length;c++){d[c]=(c+1)+".html"}a.set("contents",d)};a.loadPrev=function(){var c=a.slides.pop();var e=a.slides[0];var d=$("#mg-slide-"+c.slideId);c.left=(e.left-a.step);c.page=e.page-1;d.css("left",c.left+"%");a.slides.unshift(c);if(c.page>=0){a.loadPage(d,c.page)}};a.loadNext=function(){var c=a.slides.shift();var e=a.slides[a.slides.length-1];var d=$("#mg-slide-"+c.slideId);c.left=(e.left+a.step);c.page=e.page+1;d.css("left",c.left+"%");a.slides.push(c);if(c.page<=a.maxPage){a.loadPage(d,c.page)}};a.loadPage=function(c,d){c.load(path+""+a.get("directory")+"/"+a.currentPeriod+"/"+a.get("contents")[d],function(){a.loadSuccess(c)})};a.loadSuccess=function(d){var c;d.show();$("#"+d[0]["id"]+" article").each(function(e,f){if($.browser.webkit===true){c=new iScroll(f,a.options.scrolling)}else{c=new iScroll(f,a.options.scrolling)}});a.numberOfPagesLoaded++;if(a.get("numberOfPagesToLoad")===a.numberOfPagesLoaded){a.orientation(false);a.removeLoadingIndicator()}if($("#indexImg").attr("width")>0){$("#indexImg").bind("click",function(f){$("#indexImg").hide();$("#canvas").show();indexMovie.init()})}};a.removeLoadingIndicator=function(){a.hideOverlay()}}(mg));(function(a,b){a.prev=function(){if(a.currentPage>0){a.currentPage--;a.currentPosition+=(a.getWidth(a.firstSlide)+a.getMargin(a.firstSlide));a.animate(a.slider,a.currentPosition);a.loadPrev();a.setTitle(a.currentPeriod);a.sidebarGoTo(a.currentPage);a.addSessionData(a.getHref(),a.currentPage)}};a.next=function(){if(a.currentPage<a.maxPage){a.currentPage++;a.currentPosition-=(a.getWidth(a.firstSlide)+a.getMargin(a.firstSlide));a.animate(a.slider,a.currentPosition);a.loadNext();a.setTitle(a.currentPeriod);a.sidebarGoTo(a.currentPage);a.addSessionData(a.getHref(),a.currentPage)}};a.center=function(){var c;a.resetWidth();a.resetMargin();c=(a.getWidth(a.firstSlide)+a.getMargin(a.firstSlide))*a.slides[2].left/100*-1;console.log("width:"+c);a.currentPosition=c;a.animate(a.slider,c);if(a.options.sidebarFixed===false){a.sidebarHide("fast")}if($.os.ios===true&&parseInt($.os.version)>=5){}else{}};a.gotoPage=function(f,g){var c="middle",d,h;var e=parseInt($("#currentPeriod").attr("class"));if(e!==g){a.maxPage=(a.get("category")[a.currentPeriod].length-1)}if((a.currentPage)===f&&e===g){return}if((a.currentPage+1)===f&&e===g){a.next();return}else{if((a.currentPage-1)===f&&e===g){a.prev();return}}a.showOverlay();a.currentPage=f;a.setTitle(g);a.set("numberOfPagesToLoad",3);a.numberOfPagesLoaded=0;if(f>(a.maxPage-3)){switch(a.maxPage-f){case 0:c="last";break;case 1:c="last-but-one";break;case 2:c="last-but-two";break}}else{if(f<3){switch(f){case 0:c="first";break;case 1:c="second";break;case 2:c="third";break}}}h=a.loadingSequence[c];d=h.length-1;do{a.loadPage($("#mg-slide-"+a.slides[h[d].slide].slideId),f+h[d].page);a.slides[h[d].slide].page=f+h[d].page}while(d--);if(e!==g){$("#currentPeriod").attr("class",g)}a.setHref(a.currentPeriod);a.addSessionData(a.getHref(),a.currentPage)};a.sidebarShow=function(){var c;a.buttonOpen.hide();a.buttonClose.show();c=a.getWidth(a.sidebar);a.animate(a.sidebar,c);a.animate(a.buttonClose,c);a.animate(a.buttonOpen,c)};a.sidebarHide=function(d){var e,c=0;d=d||"slow";e=a.get("animationTime");if(d==="fast"){e="0"}a.buttonOpen.show();a.buttonClose.hide();a.animate(a.sidebar,c,0,0,e);a.animate(a.buttonClose,c,0,0,e);a.animate(a.buttonOpen,c,0,0,e)};a.changePageState=function(){var d=$("#header");var c=$("#footer");if(d.height()>0){d.height(0);c.height(0)}else{d.height(45);c.height(45)}setHeight();a.center()};a.animate=function(e,c,h,g,d,f){var c=(c||0),h=(h||0),g=(g|0),d=(d||a.get("animationTime")),f=(f||a.get("animationType"));if(a.animation==="3d"){if($.os.ios){e.animate({translate3d:c+"px,"+h+"px,"+g+"px"},d,f)}else{e.animate({translate:c+"px"},d,f)}}else{e.animate({translate:c+"px"},d,f)}};a.scrollKinetic=function(d){var e=new FlickList(d),c;e.adjustRange();return e};a.scrollKineticPage=function(d){var f=document.getElementById(d).getElementsByTagName("article");var e;for(var c=0;c<f.length;c++){e=f[c].getElementsByClassName("page");a.slideScroller[d]=a.scrollKinetic(e)}}}(mg));(function(a,b){a.sidebarListener={handleEvent:function(c){switch(c.type){case"click":break;case"transitionend":case"webkitTransitionEnd":c.target.removeEventListener(c.type,a.sidebarListener,false);setTimeout(function(){a.sidebarScroller.refresh()},0);break}}};a.addEvent=function(d,g,h,c){var f=document.getElementById(d);c=c||false;if("addEventListener" in f){try{f.addEventListener(g,h,c)}catch(j){if(typeof(h)=="object"&&h.handleEvent){f.addEventListener(g,function(k){h.handleEvent.call(h,k)},c)}else{throw j}}}else{if("attachEvent" in f){if(typeof h=="object"&&h.handleEvent){f.attachEvent("on"+g,function(){h.handleEvent.call(h)})}else{f.attachEvent("on"+g,h)}}}}}(mg));(function(a,b){if(a.touchEnabled===true){$("body").bind("touchmove",function(c){if(!c.elementIsEnabled){c.preventDefault()}})}a.bindEvents=function(){if(a.touchEnabled===true){window.addEventListener("orientationchange",a.orientation,false);a.slider.swipeRight(function(){a.prev()});a.slider.swipeLeft(function(){a.next()})}else{window.addEventListener("resize",a.center,false);$(".mg-slider-page").bind("mousedown",a.mousedown);$(".mg-slider-page").bind("mousemove",a.mousemove);$(".mg-slider-page").bind("mouseup",a.mouseup);$(window).bind("keydown",a.keydown);$(window).bind("keyup",a.keyup)}};a.orientation=function(d){setHeight();var c=window.orientation;switch(c){case 0:case 180:c="portrait";$(".landscape").hide();$(".portrait").show();break;default:c="landscape";$(".portrait").hide();$(".landscape").show()}a.center()};a.sidebarEvents=function(){if(a.touchEnabled===true){$(".sidebar-list-category").tap(a.sidebarToggle);$(".sidebar-list-item").tap(function(){a.gotoPage(parseInt($(this).attr("id").replace("page-"+a.currentPeriod+"-","")),parseInt(a.currentPeriod))})}else{$(".sidebar-list-category").bind("click",a.sidebarToggle);$(".sidebar-list-item").bind("click",function(){a.gotoPage(parseInt($(this).attr("id").replace("page-"+a.currentPeriod+"-","")),parseInt(a.currentPeriod))})}};a.sidebarToggle=function(c,d){d=d||$(this).attr("id").replace(/sidebar-category-/,"");if(a.sidebarCategoryActive===d){return}if(a.touchEnabled===true){a.addEvent("sidebar-category-content-"+d,"webkitTransitionEnd",a.sidebarListener)}else{a.addEvent("sidebar-category-content-"+d,"transitionend",a.sidebarListener)}$("#sidebar-category-content-"+a.sidebarCategoryActive).removeClass("sidebar-list-category-active");$("#sidebar-category-content-"+a.sidebarCategoryActive).css("height",0);$("#sidebar-category-content-"+d).addClass("sidebar-list-category-active");$("#sidebar-category-content-"+d).css("height",a.sidebarHightList[d]);a.sidebarCategoryActive=d;a.currentPeriod=d};a.sidebarGoTo=function(c){var d=a.getCategory(c);if(a.sidebarCategoryActive===d){}else{a.sidebarToggle(b,d)}};a.setTitle=function(d){var c=a.get("category");var e=c[d][a.currentPage];$("#header").html("<div class='left'>《HTML5微周刊》 第"+d+"期</div> "+e+"<div class='right'><!--<img src='../images/header_html5.jpg'></img>-->"+a.get("publishDate")[a.currentPeriod]+"</div>");$("#footer").text("第"+(a.currentPage+1)+"页")};a.getCategory=function(c){return a.currentPeriod};a.sidebarCalculate=function(){$(".sidebar-category-content").each(function(){var c=$(this).attr("id");c=c.replace(/sidebar-category-content-/,"");a.sidebarHightList[c]=$(this).css("height");console.log("mg.sidebarHightList"+a.sidebarHightList)})};a.mousedown=function(c){a.mouse.startX=c.clientX;a.mouse.startY=c.clientY;a.mouse.initiated=true;a.mouse.moved=false};a.mousemove=function(c){if(a.mouse.initiated===false){return}a.mouse.moved=true;a.mouse.X=c.clientX;a.mouse.Y=c.clientY};a.mouseup=function(d){if(!a.mouse.moved){return}var f=a.mouse.startY-a.mouse.Y;if(f>6||f<-6){return}var c=a.mouse.startX-a.mouse.X;if(a.mouse.startX-a.mouse.X>0){a.next()}else{a.prev()}a.mouse.initiated=false;a.mouse.moved=false};a.click=function(c){a.changePageState()};a.keydown=function(c){a.keyCode=c.keyCode};a.keyup=function(c){if(a.keyCode==74){a.changePageState()}else{if(a.keyCode==37){a.prev()}else{if(a.keyCode==39){a.next()}}}}}(mg));(function(a,b){a.getLocalData=function(c){if(typeof(localStorage)!="undefined"){return localStorage.getItem(c)}return null};a.hasLocalData=function(c){if(typeof(localStorage)!="undefined"){return localStorage.getItem(c)!=null}return false};a.addLocalData=function(c,d){if(typeof(localStorage)!="undefined"){localStorage.setItem(c,d)}};a.delLocalData=function(c){if(typeof(localStorage)!="undefined"){localStorage.removeItem(c)}};a.getSessionData=function(c){if(typeof(sessionStorage)!="undefined"){return sessionStorage.getItem(c)}return null};a.hasSessionData=function(c){if(typeof(sessionStorage)!="undefined"){return sessionStorage.getItem(c)!=null}return false};a.addSessionData=function(c,d){if(typeof(sessionStorage)!="undefined"){sessionStorage.setItem(c,d)}};a.delSessionData=function(c){if(typeof(sessionStorage)!="undefined"){sessionStorage.removeItem(c)}}}(mg));(function(b,c){var a;b.loadOptions=function(d){a=d;b.loadJson(b.setOptions)};b.loadJson=function(d){$.getJSON(b.options.json,d,function(e){console.log(e)})};b.setOptions=function(f){var e;for(e in f){b.options[e]=f[e]}b.currentPeriod=parseInt(b.get("currentPeriod"));b.allPeriod=parseInt(b.get("allPeriod"));var d=window.location.href;if(d.indexOf("#")>0){b.currentPeriod=parseInt(d.substr(d.indexOf("#")+1))}if(b.currentPeriod<b.startPeriod){b.currentPeriod=b.startPeriod}if(b.currentPeriod>b.allPeriod){b.currentPeriod=b.allPeriod}b.sidebarCategoryActive=b.currentPeriod;a()};b.getHref=function(){href=window.location.href;if(href.indexOf("#")>0){}return href};b.setHref=function(d){href=window.location.href;if(href.indexOf("#")>0){href=href.substr(0,href.indexOf("#"));window.location.href=href+"#"+d}else{window.location.href=href+"#"+d}};b.getWidth=function(e){var d;b.widthList=(b.widthList||{});console.log("obj:"+e);if(typeof(b.widthList[e[0]["id"]])!=="undefined"){return b.widthList[e[0]["id"]]}else{d=e.css("width");d=parseInt(d.replace(/px/,""));return d}};b.resetWidth=function(){b.widthList={}};b.getMargin=function(e){var d;b.marginList=(b.marginList||{});if(typeof(b.marginList[e[0]["id"]])!=="undefined"){return b.marginList[[e[0]["id"]]]}else{d=e.css("margin-left");d=parseInt(d.replace(/px/,""));return d}};b.resetMargin=function(){b.marginList={}};b.showOverlay=function(){$("#mg-loader").show()};b.hideOverlay=function(){$("#mg-loader").hide()}}(mg));mg.init();